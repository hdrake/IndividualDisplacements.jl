<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Three Dimensions · IndividualDisplacements</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit">IndividualDisplacements</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><a class="tocitem" href="../../workflow/">User Guide</a></li><li><a class="tocitem" href="../../API/">Tool Box</a></li><li><a class="tocitem" href="../../examples/">Example Guide</a></li><li><span class="tocitem">Tutorial Examples</span><ul><li><a class="tocitem" href="../../basics/random_flow_field/">Two Dimensions</a></li><li><a class="tocitem" href="../../basics/solid_body_rotation/">Three Dimensions</a></li></ul></li><li><span class="tocitem">Real Ocean Cases</span><ul><li><a class="tocitem" href="../global_ocean_circulation/">Global Climatology</a></li><li class="is-active"><a class="tocitem" href>Three Dimensions</a><ul class="internal"><li><a class="tocitem" href="#.-Load-Software"><span>1. Load Software</span></a></li><li><a class="tocitem" href="#.1-Ocean-Circulation-Setup"><span>2.1 Ocean Circulation Setup</span></a></li><li><a class="tocitem" href="#.3-Initialize-Individual-Positions"><span>2.3 Initialize Individual Positions</span></a></li><li><a class="tocitem" href="#.3-Diagnostic-/-Post-Processing-Setup"><span>2.3 Diagnostic / Post-Processing Setup</span></a></li><li><a class="tocitem" href="#.4-Individuals-Data-Structure"><span>2.4 Individuals Data Structure</span></a></li><li><a class="tocitem" href="#.1-Compute-Displacements"><span>3.1 Compute Displacements</span></a></li><li><a class="tocitem" href="#.2-Analyze-Results"><span>3.2 Analyze Results</span></a></li><li><a class="tocitem" href="#.3-Alternatives-(optional-/-unit-testing)"><span>3.3 Alternatives (optional / unit testing)</span></a></li></ul></li></ul></li><li><span class="tocitem">MITgcm Examples</span><ul><li><a class="tocitem" href="../../basics/detailed_look/">Detailed Look</a></li><li><a class="tocitem" href="../../basics/particle_cloud/">Particle Cloud</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Real Ocean Cases</a></li><li class="is-active"><a href>Three Dimensions</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Three Dimensions</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaClimate/IndividualDisplacements.jl/blob/master/examples/worldwide/three_dimensional_ocean.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Three-Dimensions"><a class="docs-heading-anchor" href="#Three-Dimensions">Three Dimensions</a><a id="Three-Dimensions-1"></a><a class="docs-heading-anchor-permalink" href="#Three-Dimensions" title="Permalink"></a></h1><p><a href="https://mybinder.org/v2/gh/JuliaClimate/IndividualDisplacements.jl/gh-pages?filepath=dev/notebooks/three_dimensional_ocean.ipynb"><img src="https://mybinder.org/badge_logo.svg" alt/></a> <a href="https://nbviewer.jupyter.org/github/JuliaClimate/IndividualDisplacements.jl/blob/gh-pages/dev/notebooks/three_dimensional_ocean.ipynb"><img src="https://img.shields.io/badge/show-nbviewer-579ACA.svg" alt/></a></p><p>Advect particles with climatological mean flow in three dimensions starting from a selected depth level (e.g. <code>k=10</code> for 95 m) and region using a near-global ocean state estimate (<a href="https://doi.org/10.1175/2009JPO4043.1">OCCA</a> which is here repeated for two years. For additional documentation e.g. see : <a href="https://JuliaClimate.github.io/MeshArrays.jl/dev/">1</a>, <a href="https://JuliaClimate.github.io/IndividualDisplacements.jl/dev/">2</a>, <a href="https://docs.juliadiffeq.org/latest/solvers/ode_solve.html">3</a>, <a href="https://en.wikipedia.org/wiki/Displacement_(vector)">4</a></p><p><img src="https://user-images.githubusercontent.com/20276764/94491485-595ee900-01b6-11eb-95e6-c2cacb812f46.png" alt="Three dimensional simulation"/></p><h2 id=".-Load-Software"><a class="docs-heading-anchor" href="#.-Load-Software">1. Load Software</a><a id=".-Load-Software-1"></a><a class="docs-heading-anchor-permalink" href="#.-Load-Software" title="Permalink"></a></h2><pre><code class="language-julia">using IndividualDisplacements, DataFrames

p=dirname(pathof(IndividualDisplacements))
include(joinpath(p,&quot;../examples/helper_functions.jl&quot;))
IndividualDisplacements.get_occa_velocity_if_needed();</code></pre><h2 id=".1-Ocean-Circulation-Setup"><a class="docs-heading-anchor" href="#.1-Ocean-Circulation-Setup">2.1 Ocean Circulation Setup</a><a id=".1-Ocean-Circulation-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#.1-Ocean-Circulation-Setup" title="Permalink"></a></h2><pre><code class="language-julia">𝑃,𝐷,Γ=OCCA_FlowFields(backward_in_time=false);</code></pre><h2 id=".3-Initialize-Individual-Positions"><a class="docs-heading-anchor" href="#.3-Initialize-Individual-Positions">2.3 Initialize Individual Positions</a><a id=".3-Initialize-Individual-Positions-1"></a><a class="docs-heading-anchor-permalink" href="#.3-Initialize-Individual-Positions" title="Permalink"></a></h2><pre><code class="language-julia">&quot;&quot;&quot;
    initial_positions(Γ; nf=10000, lon_rng=(-160.0,-159.0), lat_rng=(30.0,31.0))

Randomly assign initial positions in longitude,latitude ranges. Positions are
expressed in, normalized, grid point units (x,y in the 0,nx and 0,ny range).
To convert from longitude,latitude here we take advantage of the regularity
of the 1 degree grid being used -- for a more general alternative, see the
global ocean example.
&quot;&quot;&quot;
function initial_positions(Γ::NamedTuple, nf=10000, lon_rng=(-160.0,-159.0), lat_rng=(30.0,31.0))
   lon=lon_rng[1] .+(lon_rng[2]-lon_rng[1]).*rand(nf)
   lat=lat_rng[1] .+(lat_rng[2]-lat_rng[1]).*rand(nf)
   x=lon .+ (21. - Γ.XC[1][21,1])
   y=lat .+ (111. - Γ.YC[1][1,111])
   return x,y
end</code></pre><pre class="documenter-example-output">Main.ex-three_dimensional_ocean.initial_positions</pre><h2 id=".3-Diagnostic-/-Post-Processing-Setup"><a class="docs-heading-anchor" href="#.3-Diagnostic-/-Post-Processing-Setup">2.3 Diagnostic / Post-Processing Setup</a><a id=".3-Diagnostic-/-Post-Processing-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#.3-Diagnostic-/-Post-Processing-Setup" title="Permalink"></a></h2><pre><code class="language-julia">custom🔴 = DataFrame(ID=Int[], fid=Int[], x=Float64[], y=Float64[],
   k=Float64[], z=Float64[], iso=Float64[], t=Float64[],
   lon=Float64[], lat=Float64[], year=Float64[], col=Symbol[])

function custom🔧(sol,𝑃::𝐹_MeshArray3D;id=missing,𝑇=missing)
   df=postprocess_MeshArray(sol,𝑃,id=id,𝑇=𝑇)
   add_lonlat!(df,𝐷.XC,𝐷.YC)

   #add year (convenience time axis for plotting)
   df.year=df.t ./86400/365

   #add depth (i.e. the 3rd, vertical, coordinate)
   k=[sol[1,i,j][3] for i in 1:size(sol,2), j in 1:size(sol,3)]
   nz=length(𝐼.𝑃.u1)
   df.k=min.(max.(k[:],Ref(0.0)),Ref(nz)) #level
   k=Int.(floor.(df.k)); w=(df.k-k);
   df.z=𝐷.RF[1 .+ k].*(1 .- w)+𝐷.RF[2 .+ k].*w #depth

   #add one isotherm depth
   θ=0.5*(𝐷.θ0+𝐷.θ1)
   d=isosurface(θ,15,𝐷.RC)
   d[findall(isnan.(d))].=0.
   df.iso=interp_to_xy(df,exchange(d));

   #add color = f(iso-z)
   c=fill(:gold,length(df.iso))
   c[findall(df.iso.&lt;df.z)].=:violet
   df.col=c

   #to plot e.g. Pacific Ocean transports, shift longitude convention?
   df.lon[findall(df.lon .&lt; 0.0 )] = df.lon[findall(df.lon .&lt; 0.0 )] .+360.0
   return df
end</code></pre><pre class="documenter-example-output">custom🔧 (generic function with 1 method)</pre><h2 id=".4-Individuals-Data-Structure"><a class="docs-heading-anchor" href="#.4-Individuals-Data-Structure">2.4 Individuals Data Structure</a><a id=".4-Individuals-Data-Structure-1"></a><a class="docs-heading-anchor-permalink" href="#.4-Individuals-Data-Structure" title="Permalink"></a></h2><p>Set up <code>Individuals</code> data structure with <code>nf</code> particles moving in 3D on a regular 1 degree resolution grid covering most of the Globe.</p><pre><code class="language-julia">nf=100; lo=(-160.0,-150.0); la=(30.0,40.0); kk=2.5;
df=DataFrame(:z =&gt; fill(kk,nf),:f =&gt; fill(1,nf))
(df.x,df.y)=initial_positions(Γ, nf, lo, la)

𝐼=Individuals(𝑃,df.x,df.y,df.z,df.f,(🔴=custom🔴,🔧=custom🔧))</code></pre><pre class="documenter-example-output">  📌 details     = (1, 100) Vector{Float64}
  🔴 details     = (0, 12) [&quot;ID&quot;, &quot;fid&quot;, &quot;x&quot;, &quot;y&quot;, &quot;k&quot;, &quot;z&quot;, &quot;iso&quot;, &quot;t&quot;, &quot;lon&quot;, &quot;lat&quot;, &quot;year&quot;, &quot;col&quot;]
  🆔 range       = (1, 100)
  🚄 function    = dxdt!
  ∫  function    = default_solver
  🔧 function    = custom🔧
  𝑃  details     = (:u0, :u1, :v0, :v1, :w0, :w1, :𝑇, :update_location!)
</pre><h2 id=".1-Compute-Displacements"><a class="docs-heading-anchor" href="#.1-Compute-Displacements">3.1 Compute Displacements</a><a id=".1-Compute-Displacements-1"></a><a class="docs-heading-anchor-permalink" href="#.1-Compute-Displacements" title="Permalink"></a></h2><pre><code class="language-julia">𝑇=(0.0,10*86400.0)

∫!(𝐼,𝑇)</code></pre><pre class="documenter-example-output">1×100 Matrix{Vector{Float64}}:
 [21.1486, 118.229, 2.47994, 1.0]  …  [25.2027, 116.985, 2.47224, 1.0]</pre><h2 id=".2-Analyze-Results"><a class="docs-heading-anchor" href="#.2-Analyze-Results">3.2 Analyze Results</a><a id=".2-Analyze-Results-1"></a><a class="docs-heading-anchor-permalink" href="#.2-Analyze-Results" title="Permalink"></a></h2><p>The recorded simulation output, 🔴, is a in the <a href="https://juliadata.github.io/DataFrames.jl/latest/">DataFrames</a> tabular format, which is easily manipulated or plotted.</p><ul><li>either <code>Plots.jl</code>:</li></ul><pre><code class="language-none">include(joinpath(p,&quot;../examples/recipes_plots.jl&quot;))
p=plot(𝐼)
#p=map(𝐼,OceanDepthLog(Γ))
display(p)</code></pre><ul><li>or <code>Makie.jl</code>:</li></ul><pre><code class="language-none">include(joinpath(p,&quot;../examples/recipes_Makie.jl&quot;))
#p=plot(𝐼)
p=plot_paths(𝐼.🔴,100,180.);
display(p)</code></pre><h2 id=".3-Alternatives-(optional-/-unit-testing)"><a class="docs-heading-anchor" href="#.3-Alternatives-(optional-/-unit-testing)">3.3 Alternatives (optional / unit testing)</a><a id=".3-Alternatives-(optional-/-unit-testing)-1"></a><a class="docs-heading-anchor-permalink" href="#.3-Alternatives-(optional-/-unit-testing)" title="Permalink"></a></h2><pre><code class="language-julia">(x,y,z,f)=𝐼.📌[1]
𝐽=Individuals(𝐼.𝑃,x,y,z,f)
diff(𝐼)
gcdist(𝐼);</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../global_ocean_circulation/">« Global Climatology</a><a class="docs-footer-nextpage" href="../../basics/detailed_look/">Detailed Look »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Friday 21 May 2021 13:57">Friday 21 May 2021</span>. Using Julia version 1.6.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
